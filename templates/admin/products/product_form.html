{% extends "admin/base.html" %}
{% load static %}
{% load product_filters %}

{% block title %}{% if product %}Edit{% else %}Add{% endif %} Product - Admin{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<link rel="stylesheet" href="{% static 'admin/css/image-crop-widget.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="page-header">
      <h3 class="fw-bold mb-3">{% if product %}Edit{% else %}Add{% endif %} Product</h3>
      <ul class="breadcrumbs mb-3">
        <li class="nav-home"><a href="{% url 'admin_dashboard' %}"><i class="icon-home"></i></a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item"><a href="{% url 'admin_products' %}">Products</a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item">{% if product %}Edit{% else %}Add{% endif %}</li>
      </ul>
    </div>

    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">Product Information</h4>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              
              <div class="form-group">
                <label for="name">Product Name *</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
              </div>

              <div class="form-group">
                <label for="description">Description *</label>
                <textarea class="form-control" id="description" name="description" rows="4" required>{{ product.description }}</textarea>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="category">Category *</label>
                    <select class="form-select" id="category" name="category" required>
                      <option value="">-- Select Category --</option>
                      {% for cat in categories %}
                      <option value="{{ cat.id }}" {% if product and product.category.id == cat.id %}selected{% endif %}>
                        {{ cat.name }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="subcategory">Subcategory</label>
                    <select class="form-select" id="subcategory" name="subcategory">
                      <option value="">-- Select Subcategory --</option>
                      {% if product and product.subcategory %}
                      <option value="{{ product.subcategory.id }}" selected>{{ product.subcategory.name }}</option>
                      {% endif %}
                    </select>
                  </div>
                </div>
              </div>

              <div class="form-group field-main_image">
                <label for="main_image" style="font-weight: 600; color: #333; font-size: 15px; margin-bottom: 8px; display: block;">
                  <i class="fas fa-image" style="color: #007bff; margin-right: 5px;"></i>
                  Main Image {% if not product %}*{% endif %}
                </label>
                
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                            padding: 20px; border-radius: 12px; border: 2px dashed #007bff; 
                            margin-bottom: 15px;">
                  <p class="help-text" style="color: #555; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                    <i class="fas fa-info-circle" style="color: #007bff; margin-right: 5px;"></i>
                    <strong>Image Requirements:</strong><br>
                    üìê Target size: <strong>800 √ó 800 pixels</strong> (square ratio)<br>
                    ‚ú® After selecting, you can <strong>crop & adjust</strong> your image perfectly<br>
                    üé® Recommended: Upload high-quality images (min. 1600√ó1600px)
                  </p>
                  
                  <div style="position: relative;">
                    <input type="file" 
                           class="form-control" 
                           id="main_image" 
                           name="main_image" 
                           accept="image/*" 
                           {% if not product %}required{% endif %}
                           style="padding: 12px; 
                                  border: 2px solid #007bff; 
                                  border-radius: 8px; 
                                  font-size: 14px;
                                  background: white;
                                  cursor: pointer;
                                  transition: all 0.3s ease;">
                  </div>
                </div>
                
                {% if product and product.main_image %}
                <div style="margin-top: 15px; padding: 15px; background: #fff; border-radius: 8px; 
                            border: 2px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  <p style="margin: 0 0 10px 0; color: #28a745; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-check-circle"></i> Current Image:
                  </p>
                  <div style="display: inline-block; position: relative; border-radius: 8px; overflow: hidden;
                              box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 3px solid #28a745;">
                    <img src="{{ product.main_image.url }}" 
                         style="max-width: 300px; display: block; border-radius: 4px;"
                         alt="Current product image">
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; 
                                background: rgba(40, 167, 69, 0.9); color: white; 
                                padding: 8px; text-align: center; font-size: 12px; font-weight: 600;">
                      <i class="fas fa-check"></i> Active Product Image
                    </div>
                  </div>
                </div>
                {% endif %}
                
                <!-- Image Crop Interface -->
                <div class="image-crop-container" style="margin-top: 15px;">
                  <input type="hidden" id="id_main_image_crop_data" name="main_image_crop_data" value="">
                  <input type="hidden" id="id_main_image_aspect_ratio" value="1.0">
                  <input type="hidden" id="id_main_image_target_width" value="800">
                  <input type="hidden" id="id_main_image_target_height" value="800">
                  
                  <div class="crop-preview-section" style="display:none; margin-top: 20px; 
                                                             background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
                                                             padding: 25px; border-radius: 12px; 
                                                             border: 2px solid #007bff;
                                                             box-shadow: 0 4px 20px rgba(0, 123, 255, 0.1);
                                                             animation: slideDown 0.4s ease-out;">
                    <div style="text-align: center; margin-bottom: 20px;">
                      <h3 style="color: #007bff; margin-bottom: 8px; font-size: 22px; font-weight: 700;
                                 display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="fas fa-crop-alt" style="font-size: 24px;"></i>
                        Crop Your Image
                      </h3>
                      <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                  color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                        <i class="fas fa-expand-arrows-alt"></i> Target: <strong>500√ó281 pixels</strong> | Ratio: <strong>16:9</strong>
                      </div>
                    </div>
                    
                    <div class="crop-actions" style="margin-bottom: 20px; text-align: center; display: flex; 
                                                     gap: 10px; justify-content: center; flex-wrap: wrap;">
                      <button type="button" class="btn btn-success btn-crop-apply" 
                              style="padding: 12px 30px; font-size: 15px; font-weight: 600; 
                                     border-radius: 8px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                                     border: none; transition: all 0.3s ease; min-width: 150px;">
                        <i class="fas fa-check"></i> Apply Crop
                      </button>
                      <button type="button" class="btn btn-secondary btn-crop-reset" 
                              style="padding: 12px 30px; font-size: 15px; font-weight: 600; 
                                     border-radius: 8px; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
                                     border: none; transition: all 0.3s ease; min-width: 150px;">
                        <i class="fas fa-redo"></i> Reset
                      </button>
                      <button type="button" class="btn btn-danger btn-crop-cancel"
                              style="padding: 12px 30px; font-size: 15px; font-weight: 600; 
                                     border-radius: 8px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
                                     border: none; transition: all 0.3s ease; min-width: 150px;">
                        <i class="fas fa-times"></i> Cancel
                      </button>
                    </div>
                    
                    <div class="crop-image-wrapper" style="max-width: 100%; max-height: 600px; overflow: hidden; 
                                                           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                           border: 3px solid #007bff; 
                                                           border-radius: 12px; position: relative;
                                                           box-shadow: 0 8px 24px rgba(0, 123, 255, 0.25);
                                                           padding: 5px;">
                      <img id="crop-image-main_image" style="max-width: 100%; display: block; border-radius: 8px;">
                    </div>
                    
                    <div class="crop-info" style="margin-top: 20px; padding: 20px; 
                                                   background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                                                   border-radius: 10px; 
                                                   border-left: 5px solid #007bff;
                                                   box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);">
                      <p style="margin: 0; color: #1565c0; font-size: 14px; line-height: 1.8;">
                        <strong style="font-size: 16px; display: block; margin-bottom: 10px;">
                          <i class="fas fa-lightbulb" style="color: #ffd700;"></i> Quick Tips:
                        </strong>
                        <span style="display: block; margin-bottom: 5px;">
                          <i class="fas fa-hand-pointer" style="color: #007bff; width: 20px;"></i> 
                          <strong>Drag corners</strong> to resize the crop area
                        </span>
                        <span style="display: block; margin-bottom: 5px;">
                          <i class="fas fa-arrows-alt" style="color: #007bff; width: 20px;"></i> 
                          <strong>Drag center</strong> to move the selection
                        </span>
                        <span style="display: block; margin-bottom: 5px;">
                          <i class="fas fa-search-plus" style="color: #007bff; width: 20px;"></i> 
                          <strong>Scroll mouse</strong> to zoom in/out
                        </span>
                        <span style="display: block;">
                          <i class="fas fa-check-circle" style="color: #28a745; width: 20px;"></i> 
                          Click <strong>"Apply Crop"</strong> when satisfied
                        </span>
                      </p>
                    </div>
                    
                    <div class="crop-preview-result" style="margin-top: 25px; display: none; 
                                                            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
                                                            padding: 25px; border-radius: 12px;
                                                            border: 3px solid #28a745;
                                                            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.2);
                                                            text-align: center;
                                                            animation: fadeIn 0.5s ease-in;">
                      <h4 style="color: #155724; margin-bottom: 20px; font-size: 20px; font-weight: 700;">
                        <i class="fas fa-check-circle" style="color: #28a745; font-size: 24px;"></i>
                        Preview - Final Result
                      </h4>
                      <div style="display: inline-block; position: relative; border-radius: 12px; overflow: hidden;
                                  box-shadow: 0 8px 32px rgba(40, 167, 69, 0.3); border: 4px solid #28a745;
                                  background: white; padding: 10px;">
                        <img id="crop-preview-main_image" 
                             style="max-width: 800px; max-height: 800px; display: block; border-radius: 8px;">
                        <div style="position: absolute; top: 10px; right: 10px; 
                                    background: rgba(40, 167, 69, 0.95); color: white; 
                                    padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                          <i class="fas fa-check"></i> 800√ó800
                        </div>
                      </div>
                      <div style="margin-top: 20px; padding: 15px; 
                                  background: rgba(40, 167, 69, 0.1); 
                                  border-radius: 8px; display: inline-block;">
                        <p style="color: #28a745; margin: 0; font-weight: 600; font-size: 15px;">
                          <i class="fas fa-check-double"></i> 
                          Crop applied successfully! This is how your image will appear on the website.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label style="font-weight: 600; color: #333; font-size: 15px; margin-bottom: 15px;">
                  <i class="fas fa-ruler-combined" style="color: #007bff;"></i>
                  Available Sizes & Pricing *
                </label>
                <div id="sizes-pricing-container">
                  <!-- Will be filled dynamically by JS based on selected category -->
                </div>
              </div>

              <!-- <div class="form-group">
                <label>Available Flavors</label>
                <div class="row">
                  {% for flavor in flavors %}
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="flavors" value="{{ flavor.id }}" id="flavor{{ flavor.id }}"
                        {% if product and flavor in product.flavors.all %}checked{% endif %}>
                      <label class="form-check-label" for="flavor{{ flavor.id }}">
                        {{ flavor.name }}
                      </label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div> -->

              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {% if not product or product.is_active %}checked{% endif %}>
                <label class="form-check-label" for="is_active">
                  Active (visible to customers)
                </label>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> {% if product %}Update{% else %}Add{% endif %} Product
                </button>
                <a href="{% url 'admin_products' %}" class="btn btn-secondary">Cancel</a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">Quick Guide</h4>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Fill in product details</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Upload a clear image</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Select at least one size</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Choose applicable flavors</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success"></i> Mark as active to show on website</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Cropper.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="{% static 'admin/js/image-crop-widget.js' %}"></script>

<script>
// Utility to get map of existing selected sizes and prices from Django context (for edit mode)
const INITIAL_SELECTED_SIZES = {% if product and product.sizes.all %}[
  {% for s in product.sizes.all %}{{ s.id }},{% endfor %}
]{% else %}[]{% endif %};
const INITIAL_PRICES = {
  {% if product_prices %}
    {% for sid, price in product_prices.items %}
      {{ sid }}: '{{ price }}',
    {% endfor %}
  {% endif %}
};

function renderSizes(sizes, selectedSizes=INITIAL_SELECTED_SIZES, prices=INITIAL_PRICES) {
  const ctn = document.getElementById('sizes-pricing-container');
  if (!ctn) return;
  if (sizes.length == 0) {
    ctn.innerHTML = '<div class="alert alert-warning mt-3">Select a category to see available sizes.</div>';
    return;
  }
  let html = '<div class="row">';
  sizes.forEach(size => {
    const checked = selectedSizes.includes(size.id) ? 'checked' : '';
    const priceVal = prices[size.id] ? prices[size.id] : '';
    html += `<div class="col-md-6 col-lg-4 mb-3">
      <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="form-check" style="margin-bottom: 10px;">
          <input class="form-check-input size-checkbox" type="checkbox" name="sizes" value="${size.id}" id="size${size.id}" data-size-id="${size.id}" ${checked}>
          <label class="form-check-label" for="size${size.id}" style="font-weight: 600; color: #333;">
            ${size.name} (${size.weight_in_kg} kg)
          </label>
        </div>
        <div class="price-input-group" id="price-group-${size.id}" style="${checked ? '' : 'display:none;'}">
          <label for="price_size_${size.id}" style="font-size: 13px; color: #666;">Price (‚Çπ):</label>
          <input type="number" class="form-control" id="price_size_${size.id}" name="price_size_${size.id}" placeholder="e.g., 450, 700, 1300" step="0.01" min="0" value="${priceVal}" style="border: 2px solid #ff9800; font-weight: 600;" ${checked ? 'required' : ''}>
        </div>
      </div></div>`;
  });
  html += '</div>';
  ctn.innerHTML = html;

  // Attach size-checkbox event
  document.querySelectorAll('.size-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const sizeId = this.dataset.sizeId;
      const priceGroup = document.getElementById(`price-group-${sizeId}`);
      const priceInput = document.getElementById(`price_size_${sizeId}`);
      if (this.checked) {
        priceGroup.style.display = 'block';
        priceInput.required = true;
        priceGroup.style.animation = 'fadeIn 0.3s ease-in';
      } else {
        priceGroup.style.display = 'none';
        priceInput.required = false;
        priceInput.value = '';
      }
    });
  });
}

function loadSizesForCategory(categoryId) {
  if (!categoryId) {
    renderSizes([]);
    return;
  }
  fetch(`/admin/api/sizes/?category_id=${categoryId}`)
    .then(response => response.json())
    .then(sizesData => {
      renderSizes(sizesData);
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const catSelect = document.getElementById('category');
  if (catSelect) {
    catSelect.addEventListener('change', function() {
      const categoryId = this.value;
      loadSizesForCategory(categoryId);
    });
    // Initial form load: if editing and category preset, load sizes
    if (catSelect.value) {
      loadSizesForCategory(catSelect.value);
    }
  }
});

// Load subcategories when category changes
document.getElementById('category').addEventListener('change', function() {
  const categoryId = this.value;
  const subcategorySelect = document.getElementById('subcategory');
  
  if (!categoryId) {
    subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
    return;
  }
  
  fetch(`/admin/api/subcategories/?category_id=${categoryId}`)
    .then(response => response.json())
    .then(data => {
      subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
      data.forEach(sub => {
        subcategorySelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
      });
    });
});

// Toggle price input when size checkbox is checked/unchecked
document.querySelectorAll('.size-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const sizeId = this.dataset.sizeId;
    const priceGroup = document.getElementById(`price-group-${sizeId}`);
    const priceInput = document.getElementById(`price_size_${sizeId}`);
    
    if (this.checked) {
      priceGroup.style.display = 'block';
      priceInput.required = true;
      // Add highlight animation
      priceGroup.style.animation = 'fadeIn 0.3s ease-in';
    } else {
      priceGroup.style.display = 'none';
      priceInput.required = false;
      priceInput.value = '';
    }
  });
});

// Validate that all checked sizes have prices before submit
document.querySelector('form').addEventListener('submit', function(e) {
  const checkedSizes = document.querySelectorAll('.size-checkbox:checked');
  let hasError = false;
  let errorMessage = '';
  
  if (checkedSizes.length === 0) {
    e.preventDefault();
    alert('‚ö†Ô∏è Please select at least one size and set its price!');
    return;
  }
  
  checkedSizes.forEach(checkbox => {
    const sizeId = checkbox.dataset.sizeId;
    const priceInput = document.getElementById(`price_size_${sizeId}`);
    const sizeName = checkbox.nextElementSibling.textContent.trim();
    
    if (!priceInput.value || parseFloat(priceInput.value) <= 0) {
      hasError = true;
      errorMessage += `\n‚Ä¢ ${sizeName}: Please enter a valid price`;
      priceInput.style.border = '2px solid red';
    } else {
      priceInput.style.border = '2px solid #ff9800';
    }
  });
  
  if (hasError) {
    e.preventDefault();
    alert('‚ö†Ô∏è Please set prices for all selected sizes:' + errorMessage);
  }
});
</script>
{% endblock %}

