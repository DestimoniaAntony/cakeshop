{% extends "admin/base.html" %}
{% load static %}

{% block title %}{% if gift_box %}Edit{% else %}Add{% endif %} Gift Box - Admin{% endblock %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="page-header">
      <h3 class="fw-bold mb-3">{% if gift_box %}Edit{% else %}Add{% endif %} Gift Box</h3>
      <ul class="breadcrumbs mb-3">
        <li class="nav-home"><a href="{% url 'admin_dashboard' %}"><i class="icon-home"></i></a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item"><a href="{% url 'admin_gift_boxes' %}">Gift Boxes</a></li>
        <li class="separator"><i class="icon-arrow-right"></i></li>
        <li class="nav-item">{% if gift_box %}Edit{% else %}Add{% endif %}</li>
      </ul>
    </div>

    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">Gift Box Information</h4>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              
              <div class="form-group">
                <label for="name">Gift Box Name *</label>
                <input type="text" class="form-control" id="name" name="name" value="{% if gift_box %}{{ gift_box.name }}{% endif %}" required>
              </div>

              <div class="form-group">
                <label for="description">Description *</label>
                <textarea class="form-control" id="description" name="description" rows="4" required>{% if gift_box %}{{ gift_box.description }}{% endif %}</textarea>
              </div>

              <div class="form-group">
                <label for="main_image">Main Image *</label>
                {% if gift_box and gift_box.main_image %}
                <div class="mb-2">
                  <img src="{{ gift_box.main_image.url }}" alt="{{ gift_box.name }}" style="max-width: 300px; border-radius: 8px;">
                </div>
                {% endif %}
                <input type="file" class="form-control" id="main_image" name="main_image" accept="image/*" {% if not gift_box %}required{% endif %}>
                <small class="form-text text-muted">Upload gift box image. Recommended size: 500×281 pixels</small>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="pricing_type">Pricing Type *</label>
                    <select class="form-control" id="pricing_type" name="pricing_type" required onchange="togglePricingFields()">
                      <option value="calculated" {% if gift_box and gift_box.pricing_type == 'calculated' %}selected{% endif %}>Sum of Items</option>
                      <option value="fixed" {% if gift_box and gift_box.pricing_type == 'fixed' %}selected{% endif %}>Fixed Price</option>
                      <option value="discounted" {% if gift_box and gift_box.pricing_type == 'discounted' %}selected{% endif %}>Sum with Discount</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group" id="fixed_price_field" style="display: {% if gift_box and gift_box.pricing_type == 'fixed' %}block{% else %}none{% endif %};">
                    <label for="fixed_price">Fixed Price (₹)</label>
                    <input type="number" class="form-control" id="fixed_price" name="fixed_price" step="0.01" value="{% if gift_box %}{{ gift_box.fixed_price }}{% endif %}">
                  </div>
                  <div class="form-group" id="discount_field" style="display: {% if gift_box and gift_box.pricing_type == 'discounted' %}block{% else %}none{% endif %};">
                    <label for="discount_percentage">Discount (%)</label>
                    <input type="number" class="form-control" id="discount_percentage" name="discount_percentage" step="0.01" min="0" max="100" value="{% if gift_box %}{{ gift_box.discount_percentage }}{% endif %}">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="display_order">Display Order</label>
                    <input type="number" class="form-control" id="display_order" name="display_order" value="{% if gift_box %}{{ gift_box.display_order }}{% else %}0{% endif %}">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if not gift_box or gift_box.is_active %}checked{% endif %}>
                      <label class="form-check-label" for="is_active">
                        Active (Display on website)
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-save"></i> {% if gift_box %}Update{% else %}Create{% endif %} Gift Box
                </button>
                <a href="{% url 'admin_gift_boxes' %}" class="btn btn-secondary">
                  <i class="fa fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>

        {% if gift_box %}
        <!-- Gift Box Items Section -->
        <div class="card mt-4">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <h4 class="card-title">Gift Box Items</h4>
              <button type="button" class="btn btn-sm btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#newProductModal">
                <i class="fa fa-plus-circle"></i> Add New Product
              </button>
            </div>
          </div>
          <div class="card-body">
            <form method="post" action="{% url 'admin_gift_box_add_item' gift_box.id %}" id="addItemForm">
              {% csrf_token %}
              
              <!-- Filter by Category/Subcategory -->
              <div class="row mb-3" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="filter_category">Filter by Category</label>
                    <select class="form-control" id="filter_category" onchange="filterProducts()">
                      <option value="">All Categories</option>
                      {% for category in categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="filter_subcategory">Filter by Subcategory</label>
                    <select class="form-control" id="filter_subcategory" onchange="filterProducts()">
                      <option value="">All Subcategories</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-sm btn-secondary btn-block" onclick="resetFilters()">
                      <i class="fa fa-refresh"></i> Reset Filters
                    </button>
                  </div>
                </div>
              </div>

              <!-- Product Selection -->
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="product">Product *</label>
                    <select class="form-control" id="product" name="product" required onchange="loadSizesForProduct()">
                      <option value="">Select Product</option>
                      {% for product in products %}
                      <option value="{{ product.id }}" data-category="{{ product.category.id }}" data-subcategory="{% if product.subcategory %}{{ product.subcategory.id }}{% endif %}">
                        {{ product.name }} {% if product.subcategory %}({{ product.subcategory.name }}){% endif %}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="size">Size * <span id="size-loading" style="display:none;"><i class="fa fa-spinner fa-spin"></i></span></label>
                    <select class="form-control" id="size" name="size" required>
                      <option value="">Select Product First</option>
                    </select>
                    <small class="text-muted" id="size-price-info"></small>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label for="quantity">Quantity *</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label for="display_order_item">Order</label>
                    <input type="number" class="form-control" id="display_order_item" name="display_order" value="0">
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-success btn-block">
                      <i class="fa fa-plus"></i> Add
                    </button>
                  </div>
                </div>
              </div>
            </form>

            {% if items %}
            <div class="table-responsive mt-4">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in items %}
                  <tr>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.size.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>₹{{ item.unit_price }}</td>
                    <td><strong>₹{{ item.subtotal }}</strong></td>
                    <td>
                      <a href="{% url 'admin_gift_box_remove_item' item.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Remove this item?');">
                        <i class="fa fa-trash"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                  <tr>
                    <td colspan="4" class="text-end"><strong>Total Price:</strong></td>
                    <td colspan="2"><strong class="text-success">₹{{ gift_box.total_price|floatformat:2 }}</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              No items added yet. Add items to this gift box above.
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      <div class="col-md-4">
        <div class="card card-light">
          <div class="card-header">
            <h4 class="card-title">Help</h4>
          </div>
          <div class="card-body">
            <h6>Pricing Types:</h6>
            <ul style="font-size: 13px;">
              <li><strong>Sum of Items:</strong> Price is automatically calculated by summing up all item prices.</li>
              <li><strong>Fixed Price:</strong> Set a fixed price regardless of items included.</li>
              <li><strong>Sum with Discount:</strong> Calculate sum of items and apply a discount percentage.</li>
            </ul>
            
            {% if gift_box %}
            <hr>
            <h6>Adding Items:</h6>
            <p style="font-size: 13px;">
              Select products and sizes to include in this gift box. The total price will be calculated automatically based on your pricing type.
            </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Product Modal -->
<div class="modal fade" id="newProductModal" tabindex="-1" aria-labelledby="newProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newProductModalLabel">
          <i class="fa fa-plus-circle"></i> Add New Product
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="newProductForm" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="required">Product Name *</label>
                <input type="text" class="form-control" id="new_product_name" name="name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Product Image (Optional)</label>
                <input type="file" class="form-control" id="new_product_image" name="main_image" accept="image/*">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Description (Optional)</label>
            <textarea class="form-control" id="new_product_description" name="description" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="required">Category *</label>
                <select class="form-control" id="new_product_category" name="category_id" required onchange="loadSubcategoriesForNewProduct()">
                  <option value="">Select Category</option>
                  {% for category in categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
                <small class="text-muted">Required - for product organization</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Subcategory (Optional)</label>
                <select class="form-control" id="new_product_subcategory" name="subcategory_id">
                  <option value="">None</option>
                </select>
                <small class="text-muted">Leave as None if not needed</small>
              </div>
            </div>
          </div>
          
          <hr>
          <h6>Add Size & Price</h6>
          <div id="size-price-forms">
            <div class="row size-price-row" style="margin-bottom: 10px;">
              <div class="col-md-4">
                <input type="text" class="form-control" name="size_names[]" placeholder="Size (e.g., 1 kg)" required>
              </div>
              <div class="col-md-3">
                <input type="number" class="form-control" name="size_weights[]" step="0.01" placeholder="Weight (kg)" value="1.0">
              </div>
              <div class="col-md-4">
                <input type="number" class="form-control" name="size_prices[]" step="0.01" placeholder="Price (₹)" required>
              </div>
              <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSizeRow(this)">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="addSizeRow()">
            <i class="fa fa-plus"></i> Add Another Size
          </button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> Create Product
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Pricing fields toggle
function togglePricingFields() {
  const pricingType = document.getElementById('pricing_type').value;
  const fixedPriceField = document.getElementById('fixed_price_field');
  const discountField = document.getElementById('discount_field');
  
  fixedPriceField.style.display = 'none';
  discountField.style.display = 'none';
  
  if (pricingType === 'fixed') {
    fixedPriceField.style.display = 'block';
  } else if (pricingType === 'discounted') {
    discountField.style.display = 'block';
  }
}

// Filter products by category/subcategory
function filterProducts() {
  const categoryId = document.getElementById('filter_category').value;
  const subcategoryId = document.getElementById('filter_subcategory').value;
  const productSelect = document.getElementById('product');
  const allOptions = productSelect.querySelectorAll('option[data-category]');
  
  // Load subcategories if category is selected
  if (categoryId) {
    loadSubcategories(categoryId, 'filter_subcategory');
  } else {
    document.getElementById('filter_subcategory').innerHTML = '<option value="">All Subcategories</option>';
  }
  
  // Filter products
  allOptions.forEach(option => {
    const optionCategory = option.getAttribute('data-category');
    const optionSubcategory = option.getAttribute('data-subcategory') || '';
    
    if (!categoryId && !subcategoryId) {
      option.style.display = '';
    } else if (categoryId && subcategoryId) {
      option.style.display = (optionCategory === categoryId && optionSubcategory === subcategoryId) ? '' : 'none';
    } else if (categoryId) {
      option.style.display = (optionCategory === categoryId) ? '' : 'none';
    }
  });
  
  // Reset product and size selection
  productSelect.value = '';
  document.getElementById('size').innerHTML = '<option value="">Select Product First</option>';
  document.getElementById('size-price-info').textContent = '';
}

// Reset filters
function resetFilters() {
  document.getElementById('filter_category').value = '';
  document.getElementById('filter_subcategory').innerHTML = '<option value="">All Subcategories</option>';
  filterProducts();
}

// Load subcategories for filter
function loadSubcategories(categoryId, targetId) {
  fetch(`{% url 'get_subcategories' %}?category_id=${categoryId}`)
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById(targetId);
      select.innerHTML = '<option value="">All Subcategories</option>';
      data.forEach(subcat => {
        const option = document.createElement('option');
        option.value = subcat.id;
        option.textContent = subcat.name;
        select.appendChild(option);
      });
    });
}

// Load subcategories for new product modal
function loadSubcategoriesForNewProduct() {
  const categoryId = document.getElementById('new_product_category').value;
  const subcatSelect = document.getElementById('new_product_subcategory');
  
  if (categoryId) {
    fetch(`{% url 'get_subcategories' %}?category_id=${categoryId}`)
      .then(response => response.json())
      .then(data => {
        subcatSelect.innerHTML = '<option value="">None (No Subcategory)</option>';
        data.forEach(subcat => {
          const option = document.createElement('option');
          option.value = subcat.id;
          option.textContent = subcat.name;
          subcatSelect.appendChild(option);
        });
      });
  } else {
    subcatSelect.innerHTML = '<option value="">None</option>';
  }
}

// Load sizes for selected product
function loadSizesForProduct() {
  const productId = document.getElementById('product').value;
  const sizeSelect = document.getElementById('size');
  const sizeInfo = document.getElementById('size-price-info');
  const sizeLoading = document.getElementById('size-loading');
  
  if (!productId) {
    sizeSelect.innerHTML = '<option value="">Select Product First</option>';
    sizeInfo.textContent = '';
    return;
  }
  
  sizeLoading.style.display = 'inline';
  sizeSelect.innerHTML = '<option value="">Loading...</option>';
  
  fetch(`{% url 'get_sizes_for_product' %}?product_id=${productId}`)
    .then(response => response.json())
    .then(data => {
      sizeLoading.style.display = 'none';
      sizeSelect.innerHTML = '<option value="">Select Size</option>';
      
      if (data.length === 0) {
        sizeSelect.innerHTML = '<option value="">No sizes available</option>';
        sizeInfo.innerHTML = '<span class="text-warning">No sizes found. Add sizes using "Add New Product" button.</span>';
      } else {
        data.forEach(size => {
          const option = document.createElement('option');
          option.value = size.id;
          option.textContent = `${size.name} - ₹${size.price}`;
          option.setAttribute('data-price', size.price);
          sizeSelect.appendChild(option);
        });
        sizeInfo.textContent = '';
      }
    })
    .catch(error => {
      sizeLoading.style.display = 'none';
      sizeSelect.innerHTML = '<option value="">Error loading sizes</option>';
      console.error('Error:', error);
    });
}

// Create new product inline
document.getElementById('newProductForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  // Get all size data
  const sizeNames = [];
  const sizeWeights = [];
  const sizePrices = [];
  
  document.querySelectorAll('.size-price-row').forEach(row => {
    const nameInput = row.querySelector('input[name="size_names[]"]');
    const weightInput = row.querySelector('input[name="size_weights[]"]');
    const priceInput = row.querySelector('input[name="size_prices[]"]');
    
    if (nameInput.value && priceInput.value) {
      sizeNames.push(nameInput.value);
      sizeWeights.push(weightInput.value || '1.0');
      sizePrices.push(priceInput.value);
    }
  });
  
  if (sizeNames.length === 0) {
    alert('Please add at least one size and price for the product.');
    return;
  }
  
  // Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating...';
  
  // Create product first
  fetch('{% url "create_product_inline" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Now create sizes and prices
      const promises = sizeNames.map((name, index) => {
        const sizeFormData = new FormData();
        sizeFormData.append('product_id', data.product.id);
        sizeFormData.append('size_name', name);
        sizeFormData.append('size_weight', sizeWeights[index]);
        sizeFormData.append('price', sizePrices[index]);
        
        return fetch('{% url "create_product_size_price" %}', {
          method: 'POST',
          body: sizeFormData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        }).then(r => r.json());
      });
      
      Promise.all(promises).then(results => {
        // Refresh product dropdown
        const productSelect = document.getElementById('product');
        const newOption = document.createElement('option');
        newOption.value = data.product.id;
        newOption.textContent = `${data.product.name}${data.product.subcategory ? ' (' + data.product.subcategory + ')' : ''}`;
        newOption.setAttribute('data-category', document.getElementById('new_product_category').value);
        const subcategoryId = document.getElementById('new_product_subcategory').value;
        newOption.setAttribute('data-subcategory', subcategoryId || '');
        newOption.selected = true;
        productSelect.appendChild(newOption);
        
        // Close modal and load sizes
        const modal = bootstrap.Modal.getInstance(document.getElementById('newProductModal'));
        if (modal) modal.hide();
        loadSizesForProduct();
        document.getElementById('newProductForm').reset();
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa fa-save"></i> Create Product';
        
        alert('Product created successfully! You can now add it to the gift box.');
      });
    } else {
      alert('Error: ' + data.error);
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa fa-save"></i> Create Product';
    }
  })
  .catch(error => {
    alert('Error creating product: ' + error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fa fa-save"></i> Create Product';
  });
});

// Add size row
function addSizeRow() {
  const container = document.getElementById('size-price-forms');
  const newRow = document.createElement('div');
  newRow.className = 'row size-price-row';
  newRow.style.marginBottom = '10px';
  newRow.innerHTML = `
    <div class="col-md-4">
      <input type="text" class="form-control" name="size_names[]" placeholder="Size (e.g., 1 kg)" required>
    </div>
    <div class="col-md-3">
      <input type="number" class="form-control" name="size_weights[]" step="0.01" placeholder="Weight (kg)" value="1.0">
    </div>
    <div class="col-md-4">
      <input type="number" class="form-control" name="size_prices[]" step="0.01" placeholder="Price (₹)" required>
    </div>
    <div class="col-md-1">
      <button type="button" class="btn btn-danger btn-sm" onclick="removeSizeRow(this)">
        <i class="fa fa-times"></i>
      </button>
    </div>
  `;
  container.appendChild(newRow);
}

// Remove size row
function removeSizeRow(btn) {
  const rows = document.querySelectorAll('.size-price-row');
  if (rows.length > 1) {
    btn.closest('.size-price-row').remove();
  } else {
    alert('At least one size must be defined.');
  }
}
</script>
{% endblock %}
